/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */

import {test_util} from '@tensorflow/tfjs-core';
import {loadQnA, UniversalSentenceEncoderQnA} from './use_qna';

describe('Universal Sentence Encoder QNA', () => {
  let qna: UniversalSentenceEncoderQnA;
  beforeAll(async () => {
    qna = await loadQnA();
  });

  it('basic usage', () => {
    const result = qna.embed({
      queries: ['what is the weather today?'],
      responses: [{response: 'today is cloudy.'}]
    });
    test_util.expectArraysClose(result['queryEmbedding'][0], [
      0.5138696432113647,    0.4062872529029846,    0.5019606351852417,
      0.04275975748896599,   -0.32674574851989746,  -0.027402503415942192,
      -0.025836700573563576, 0.5502961277961731,    -0.2103944569826126,
      0.49785712361335754,   0.081525057554245,     0.22398652136325836,
      -0.5018055438995361,   -0.026320265606045723, 0.2853192687034607,
      -1.0731146335601807,   -0.4180041253566742,   -0.2342546582221985,
      -0.6500006318092346,   0.5140395164489746,    -0.282049298286438,
      -0.1937585324048996,   -0.21799495816230774,  0.2999749183654785,
      -0.03810271620750427,  -0.2865232825279236,   0.4645285904407501,
      0.11117757856845856,   -0.46886396408081055,  1.043837070465088,
      -0.8555026054382324,   -0.7233202457427979,   -0.9623907208442688,
      0.1581660658121109,    -0.042067695409059525, 0.7932420969009399,
      0.012831592001020908,  0.7939139008522034,    -0.2834923267364502,
      0.4093143939971924,    0.4908010959625244,    -0.436528742313385,
      0.9213767647743225,    -0.6028625965118408,   -0.5834630131721497,
      0.70222008228302,      -0.09474120289087296,  -0.7579330205917358,
      -0.17452281713485718,  0.12610667943954468,   -0.07310611009597778,
      0.12635181844234467,   -0.08930797129869461,  0.7664811611175537,
      -0.36941105127334595,  -0.07391694188117981,  0.5893040895462036,
      0.7914494872093201,    -0.02591519244015217,  -0.3800516724586487,
      0.33293163776397705,   -0.5492694973945618,   0.6965757012367249,
      -0.3734380304813385,   -1.078788161277771,    -0.4960654377937317,
      0.23836150765419006,   -0.492328941822052,    0.5221622586250305,
      -0.0698433667421341,   -0.35218846797943115,  -1.0516977310180664,
      -0.3597252070903778,   -0.8361276984214783,   0.016579391434788704,
      0.09939181059598923,   -0.43573522567749023,  0.30250442028045654,
      0.014143560081720352,  -0.037820007652044296, 0.6228828430175781,
      -0.29468753933906555,  -0.14220786094665527,  -0.08079525083303452,
      -0.5755635499954224,   0.377921998500824,     0.4391230642795563,
      -0.532068133354187,    -0.017972227185964584, 0.5451188087463379,
      0.8659032583236694,    -0.0896892249584198,   0.37990421056747437,
      0.9683977365493774,    -0.5411171913146973,   -0.6022316813468933,
      -0.499037504196167,    0.20280538499355316,   0.6493942141532898,
      -0.49726271629333496
    ]);
    test_util.expectArraysClose(result['responseEmbedding'][0], [
      0.17638875544071198,   -0.32149386405944824, 0.3875231444835663,
      -0.09246233850717545,  -0.26154616475105286, 0.5330878496170044,
      -0.391889750957489,    0.3289341628551483,   -0.14068986475467682,
      0.5296584963798523,    -0.22243782877922058, -0.48953869938850403,
      -0.0291469506919384,   0.3307526409626007,   0.12390077859163284,
      -0.47187304496765137,  -0.16010484099388123, 0.4942947328090668,
      0.9514716863632202,    0.24592052400112152,  -0.3391081392765045,
      -0.014908344484865665, 0.7634990215301514,   0.005359052214771509,
      0.323579341173172,     0.06229443475604057,  0.749360203742981,
      -0.23696540296077728,  -0.767392098903656,   0.27687567472457886,
      -0.26682448387145996,  -0.6903975009918213,  -0.4230061173439026,
      0.1688353717327118,    0.35955703258514404,  0.7540332674980164,
      0.32789334654808044,   0.5332770347595215,   -0.6243453025817871,
      0.3815247714519501,    -0.2633530795574188,  -0.36990100145339966,
      0.7483318448066711,    -0.41426798701286316, -0.5415680408477783,
      1.1488806009292603,    0.15245792269706726,  -0.8324363827705383,
      0.32871004939079285,   0.0903034433722496,   -0.89601069688797,
      0.4679499566555023,    0.2749922573566437,   0.4042767584323883,
      0.289889395236969,     0.1547282487154007,   0.8036004900932312,
      -0.47011616826057434,  -0.8641259670257568,  -0.707637369632721,
      0.5873814225196838,    -0.13389572501182556, 0.19640345871448517,
      -0.5914590954780579,   -1.2063833475112915,  -0.3345429301261902,
      0.5799098014831543,    0.3280044496059418,   -0.14751845598220825,
      0.3291359543800354,    -0.49879685044288635, -0.6965380311012268,
      -0.31093278527259827,  1.2828885316848755,   -0.2296813577413559,
      0.14339478313922882,   0.21841493248939514,  0.3449305295944214,
      -0.07026386260986328,  -0.08858160674571991, 0.6678345203399658,
      0.3256532847881317,    -0.4275289475917816,  -0.8676577210426331,
      -0.203995943069458,    0.2095945179462433,   0.5089327692985535,
      -0.5380121469497681,   0.2671135663986206,   0.3708978295326233,
      -0.0801892951130867,   0.5475533604621887,   0.39765268564224243,
      0.733525276184082,     -0.0666082501411438,  0.2393379956483841,
      -0.9545280933380127,   0.3222697973251343,   0.3868270218372345,
      -0.633151650428772
    ]);
  });
});
